# üîß Bot Hanging Issues - Diagnosis and Fix

## –ü—Ä–æ–±–ª–µ–º–∞
–¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç –∑–∞–≤–∏—Å–∞–µ—Ç —á–µ—Ä–µ–∑ ~15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞, —Ö–æ—Ç—è —Å–µ—Ä–≤–∏—Å –Ω–µ –ø–∞–¥–∞–µ—Ç. –ü—Ä–∏—á–∏–Ω–∞ - —É—Ç–µ—á–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ HTTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ñ–µ—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
- **–§–∞–π–ª**: `CONFIG/limits.py`
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: `MAX_ANIMATION_DURATION = 14400` (4 —á–∞—Å–∞)
- **–≠—Ñ—Ñ–µ–∫—Ç**: –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ 4 —á–∞—Å–∞

### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
- **–§–∞–π–ª**: `HELPERS/http_manager.py` (–Ω–æ–≤—ã–π)
- **–§—É–Ω–∫—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ 4 —á–∞—Å–∞
- **–≠—Ñ—Ñ–µ–∫—Ç**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç CLOSE-WAIT —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
- **–§–∞–π–ª**: `HELPERS/download_status.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∂–µ—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –≤ `animate_hourglass()` –∏ `cycle_progress()`
- **–≠—Ñ—Ñ–µ–∫—Ç**: –ü–æ—Ç–æ–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–µ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

### 4. –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- **–§–∞–π–ª**: `_etc/systemd/system/tg-ytdlp-bot.service`
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: `LimitNOFILE=65535`, `LimitNPROC=4096`
- **–≠—Ñ—Ñ–µ–∫—Ç**: –£–≤–µ–ª–∏—á–µ–Ω—ã –ª–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å TCP keepalive –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```bash
sudo ./scripts/configure_tcp_keepalive.sh
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
sudo systemctl restart tg-ytdlp-bot
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
./scripts/monitor_bot_resources.sh monitor

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑
./scripts/monitor_bot_resources.sh check
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏
```bash
# –ù–∞–π—Ç–∏ PID –±–æ—Ç–∞
pid=$(pgrep -f "python.*magic.py")

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ç–æ–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
py-spy dump -p $pid | grep -c "animate_hourglass"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CLOSE-WAIT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
ss -tuln | grep CLOSE-WAIT

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–µ—Ç–µ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±–æ—Ç–∞
lsof -p $pid -nP | grep -E 'TCP|UDP'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤
ls -1 /proc/$pid/fd | wc -l

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
lsof -p $pid | head -20
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ñ–æ–Ω–µ
nohup ./scripts/monitor_bot_resources.sh monitor > /dev/null 2>&1 &

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f /var/log/bot-monitor.log
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
./scripts/monitor_bot_resources.sh check

# –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
./scripts/monitor_bot_resources.sh report
cat /tmp/bot-report.txt
```

## üö® –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ
- –ü—Ä–æ—Ü–µ—Å—Å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `D` (uninterruptible sleep)
- –ë–æ–ª–µ–µ 5 –ø–æ—Ç–æ–∫–æ–≤ `animate_hourglass`
- –ë–æ–ª–µ–µ 100 CLOSE-WAIT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ë–æ–ª–µ–µ 1000 –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤

### –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–µ
- CPU –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ > 90%
- –ë–æ–ª–µ–µ 50 –ø–æ—Ç–æ–∫–æ–≤
- –ë–æ–ª–µ–µ 50 –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## üîÑ –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### –ü—Ä–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–∏ –±–æ—Ç–∞
1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
   ```bash
   ./scripts/monitor_bot_resources.sh check
   ```

2. **–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç**:
   ```bash
   ./scripts/monitor_bot_resources.sh report
   ```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞**:
   ```bash
   sudo systemctl restart tg-ytdlp-bot
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏**:
   ```bash
   journalctl -u tg-ytdlp-bot -f
   ```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –ê–Ω–∏–º–∞—Ü–∏–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –º–∞–∫—Å–∏–º—É–º 4 —á–∞—Å–∞
- ‚úÖ HTTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ù–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è CLOSE-WAIT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ /etc/security/limits.conf
* soft nofile 65535
* hard nofile 65535
* soft nproc 4096
* hard nproc 4096
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ cron
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab
*/5 * * * * /path/to/scripts/monitor_bot_resources.sh check
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: `./scripts/monitor_bot_resources.sh report`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `journalctl -u tg-ytdlp-bot -n 100`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å: `sudo systemctl restart tg-ytdlp-bot`
